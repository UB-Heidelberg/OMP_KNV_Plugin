{{from gluon.serializers import xml}}
{{

xml_string='<ONIXMessage xmlns="http://ns.editeur.org/onix/3.0/reference" release="3.0"><Header><Sender><SenderIdentifier><SenderIDType></SenderIDType><IDValue></IDValue></SenderIdentifier><SenderName>XXXXXSedici Editorial</SenderName><ContactName>XXXXXXXXSEDICI</ContactName><EmailAddress>XXXXXXXXXXxxsedici@gmail.com</EmailAddress></Sender><SentDateTime>20150416</SentDateTime></Header><Product><RecordReference>'
#+myconf.take("omp.url")+'/research/xxxxxx/view/'+str(data[0]['submission_id'])+'
xml_string+='</RecordReference><NotificationType>03</NotificationType><RecordSourceType>04</RecordSourceType><ProductIdentifier><ProductIDType>15</ProductIDType><IDValue>6784563452341</IDValue></ProductIdentifier><DescriptiveDetail><ProductComposition>00</ProductComposition><ProductForm>DA</ProductForm><ProductFormDetail>E107</ProductFormDetail><EpubTechnicalProtection>00</EpubTechnicalProtection><Collection><CollectionType>10</CollectionType><TitleDetail><TitleType>01</TitleType><TitleElement><TitleElementLevel>02</TitleElementLevel></TitleElement></TitleDetail></Collection><TitleDetail><TitleType>01</TitleType><TitleElement><TitleElementLevel>01</TitleElementLevel><TitleText>Great paper</TitleText></TitleElement></TitleDetail><Contributor><SequenceNumber>1</SequenceNumber><ContributorRole>A01</ContributorRole><PersonName>John Doe</PersonName><PersonNameInverted>Doe, John</PersonNameInverted><NamesBeforeKey>John</NamesBeforeKey><KeyNames>Doe</KeyNames><BiographicalNote></BiographicalNote><ContributorPlace><ContributorPlaceRelator>04</ContributorPlaceRelator><CountryCode>CA</CountryCode></ContributorPlace></Contributor><Extent><ExtentType>08</ExtentType><ExtentValue>0.3</ExtentValue><ExtentUnit>05</ExtentUnit></Extent><Subject><MainSubject></MainSubject><SubjectSchemeIdentifier>12</SubjectSchemeIdentifier><SubjectSchemeVersion>2</SubjectSchemeVersion></Subject></DescriptiveDetail><CollateralDetail><TextContent><TextType>02</TextType><ContentAudience>00</ContentAudience><Text>This is a really good paper</Text></TextContent><TextContent><TextType>03</TextType><ContentAudience>00</ContentAudience><Text>This is a really good paper</Text></TextContent></CollateralDetail><PublishingDetail><Publisher><PublishingRole>01</PublishingRole><PublisherName>norma editorial</PublisherName><Website><WebsiteRole>18</WebsiteRole><WebsiteLink>http://omp.sfu.ca/testdrive/index.php/research</WebsiteLink></Website></Publisher><CityOfPublication>argentina</CityOfPublication><ROWSalesRightsType>02</ROWSalesRightsType></PublishingDetail><ProductSupply><Market><Territory/></Market><MarketPublishingDetail><MarketPublishingStatus>04</MarketPublishingStatus><MarketDate><MarketDateRole>01</MarketDateRole><DateFormat>20</DateFormat><Date>20130801</Date></MarketDate></MarketPublishingDetail><SupplyDetail><Supplier><SupplierRole>09</SupplierRole><SupplierName>norma editorial</SupplierName><EmailAddress>sedici@gmail.com</EmailAddress><Website><WebsiteRole>18</WebsiteRole><WebsiteLink>http://omp.sfu.ca/testdrive/index.php/research</WebsiteLink></Website></Supplier><ProductAvailability>20</ProductAvailability><Price><PriceAmount>0</PriceAmount><CurrencyCode>GBP</CurrencyCode></Price></SupplyDetail></ProductSupply></Product></ONIXMessage>'

}}

{{
'''
def codes_role(x):
    return {
        'AU': 'A01',
        'VE': 'B01',
        'Trans' : 'B06',
        'PE' : 'B21',
        'PM' : 'PM',
        'CA' : 'PM'
    }
'''
produkt =''
biography = ''
#for  person in authors_pre:
#    role = db((person.user_group_id== db.user_group_settings.user_group_id) & (db.user_group_settings.locale==locale) & (db.user_group_settings.setting_name=='abbrev')).select(db.user_group_settings.setting_value).first()['setting_value']
#    biography =  db((db.author_settings.author_id==person.author_id)  & (db.author_settings.locale==locale) & (db.author_settings.setting_name=='biography')).select(db.author_settings.setting_value).first()
#   }}
  {{if not biography:
    biography = ''
  }}
 {{pass}}
{{
#produkt += '<Product><Contributor><SequenceNumber>1</SequenceNumber><ContributorRole>'+ codes_role(role)+'</ContributorRole><PersonName>'+person.first_name+' '+person.last_name+'</PersonName><PersonNameInverted>'+person.last_name+', '+person.first_name+'</PersonNameInverted><NamesBeforeKey>'+person.first_name+'</NamesBeforeKey><BiographicalNote>'+biography+'</BiographicalNote><ContributorPlace><ContributorPlaceRelator>04</ContributorPlaceRelator><CountryCode>'+person.country+'</CountryCode></ContributorPlace></Contributor></Product>'
}}
{{#pass}}
{{
header=''
header='<Header>'
header+='	<Sender>'
header+='		<SenderIdentifier>'
header+='			<SenderIDType>06</SenderIDType>'
header+='			<IDValue>XXXXXXXXXXX</IDValue>'
header+='		</SenderIdentifier>'
header+='		<SenderName>Heidelberg University Publishing</SenderName>'
header+='		<ContactName>Martin Nissen</ContactName>'
header+='		<EmailAddress>nissen@ub.uni-heidelberg.de</EmailAddress>'
header+='	</Sender>'
header+='	<SentDateTime>'
if data:
	if data['f_sende_datum']:
		header+=str(data['f_sende_datum']).replace('-','')
	pass
pass
header+='</SentDateTime></Header>'
}}

{{
descriptive_detail=''
pc = '00'
pf = ''
pfd = ''
etp=''


col='<Collection>'
col+='	<CollectionType>10</CollectionType>'
col+='	<TitleDetail>'
col+='		<TitleText>'+title_text+'</TitleText>'
col+='		<TitleType>01</TitleType>'
col+='		<TitleElement>'
col+='			<TitleElementLevel>02</TitleElementLevel>'
col+='		</TitleElement>'
col+='	</TitleDetail>'
col+='</Collection>'
 }}
{{ for format in publication_formats:
   if format['product_composition_code']:
      pc = format['product_composition_code']
   pass
   if format['entry_key']:
      pf = format['entry_key']
   pass
   if format['product_form_detail_code']:
      pfd = format['product_form_detail_code']
   pass
   if format['technical_protection_code']:
      etp = format['technical_protection_code']
   pass
   descriptive_detail+='<DescriptiveDetail>'
   descriptive_detail+='	<ProductComposition>'+pc+'</ProductComposition>'
   descriptive_detail+='	<ProductForm>'+pf+'</ProductForm>'
   descriptive_detail+='	<ProductFormDetail>'+pfd+'</ProductFormDetail>'
   descriptive_detail+='	<EpubTechnicalProtection>'+etp+'</EpubTechnicalProtection>'
   descriptive_detail+='</DescriptiveDetail>'
pass
}}



{{}}
{{=XML(xml_string,sanitize=False)}}
